<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß B√°nh H·∫±ng Ng√†y - Bakery Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Nunito', 'Segoe UI', sans-serif; }

        /* Toolbar */
        .glass-toolbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 20px;
        }

        /* Filter Tabs */
        .nav-pills .nav-link {
            color: #6c757d;
            font-weight: 600;
            border-radius: 20px;
            padding: 8px 20px;
            margin-right: 10px;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-pills .nav-link.active {
            background-color: #0dcaf0;
            color: white;
            border-color: #0dcaf0;
            box-shadow: 0 4px 10px rgba(13, 202, 240, 0.3);
        }

        /* Product Card */
        .product-card {
            border: none;
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        }
        .card-img-wrapper {
            position: relative;
            height: 160px;
            overflow: hidden;
            background: #f8f9fa;
        }
        .card-img-top {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.3s;
        }

        /* Status Badge */
        .status-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 2;
        }

        /* Card Out of stock styling */
        .out-of-stock .card-img-top { filter: grayscale(100%); opacity: 0.7; }
        .out-of-stock .product-card { border: 2px solid #f8d7da; }

        /* Stepper Input */
        .stepper {
            display: flex;
            align-items: center;
            background: #f1f3f5;
            border-radius: 30px;
            padding: 5px;
            margin-top: 10px;
        }
        .btn-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: white;
            color: #495057;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .btn-step:hover { background: #e9ecef; }
        .btn-step.minus { color: #dc3545; }
        .btn-step.plus { color: #198754; }

        .stepper-input {
            flex: 1;
            min-width: 0; /* D√≤ng b√πa ch√∫ 1: √âp input kh√¥ng ƒë∆∞·ª£c ph√¨nh to qu√° gi·ªõi h·∫°n */
            width: 100%;  /* D√≤ng b√πa ch√∫ 2: ∆Øu ti√™n co gi√£n v·ª´a v·∫∑n */
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 800;
            color: #212529;
            outline: none;
            -moz-appearance: textfield; /* ·∫®n n√∫t m≈©i t√™n tr√™n Firefox */
        }

        /* ·∫®n ho√†n to√†n m≈©i t√™n l√™n/xu·ªëng m·∫∑c ƒë·ªãnh c·ªßa Chrome/Safari/Edge ƒë·ªÉ UI g·ªçn h∆°n */
        .stepper-input::-webkit-outer-spin-button,
        .stepper-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Stats Info */
        .stock-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .btn-back { color: #495057; font-size: 1.2rem; margin-right: 15px; transition: 0.2s; }
        .btn-back:hover { color: #0dcaf0; }
        /* C√°c n√∫t c√¥ng c·ª• ·∫®n/Hi·ªán & Gi·∫£m gi√° */
        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 5;
        }
        .btn-action-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .btn-action-icon:hover { transform: scale(1.1); }
        .btn-eye { background-color: #6c757d; } /* X√°m */
        .btn-eye.is-hidden { background-color: #dc3545; } /* ƒê·ªè khi ƒëang b·ªã ·∫©n */
        .btn-discount { background-color: #fd7e14; } /* Cam */

        /* D·∫£i bƒÉng gi·∫£m gi√° */
        .discount-ribbon {
            position: absolute;
            top: 45px;
            right: -5px;
            background: #dc3545;
            color: white;
            padding: 3px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
            border-radius: 4px 0 0 4px;
        }
        /* L·ªõp ph·ªß l√†m m·ªù th·∫ª n·∫øu b·ªã ·∫©n */
        .card-dimmed { opacity: 0.5; filter: grayscale(50%); }
    </style>
</head>
<body>

<div class="glass-toolbar d-flex justify-content-between align-items-center shadow-sm">
    <div class="d-flex align-items-center gap-2">
        <a href="/orders/admin/products" class="btn-back" title="Quay l·∫°i"><i class="fa-solid fa-arrow-left"></i></a>
        <h4 class="mb-0 fw-bold text-dark"><i class="fa-solid fa-store text-info me-2"></i>T·ªß B√°nh</h4>
        <div class="vr mx-2"></div>
        <input type="date" class="form-control fw-bold text-primary border-primary bg-light" id="saleDate" style="max-width: 180px;">
    </div>

    <div class="d-flex gap-2">
        <button class="btn btn-info fw-bold text-white px-4" onclick="saveAllStock()">
            <i class="fa-solid fa-cloud-arrow-up me-2"></i>L∆∞u ƒê·ªìng B·ªô
        </button>
    </div>
</div>

<div class="container-fluid p-4">

    <ul class="nav nav-pills mb-4" id="categoryTabs">
        <li class="nav-item"><button class="nav-link active" data-filter="all">üåü T·∫•t c·∫£ b√°nh</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="B√°nh M√¨">ü•ñ B√°nh M√¨</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="B√°nh Ng·ªçt">üßÅ B√°nh Ng·ªçt</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="B√°nh L·∫°nh">üç∞ B√°nh L·∫°nh</button></li>
    </ul>

    <div class="row g-4" id="productGrid">
        <div th:each="p : ${products}"
             th:with="stock=${stockMap != null ? stockMap.get(p.productId) : null},
                      initialQty=${stock != null ? stock.initialQuantity : 0},
                      availQty=${stock != null ? stock.availableQuantity : 0}"
             class="col-xl-3 col-lg-4 col-md-6 col-sm-6 filter-item"
             th:classappend="${p.category}"
             th:attr="data-product-id=${p.productId}, data-category=${p.category}">

            <div class="product-card shadow-sm border position-relative" th:classappend="${!p.isVisible ? 'card-dimmed' : ''}">

                <div class="card-actions">
                    <button type="button" class="btn-action-icon btn-eye" th:classappend="${!p.isVisible ? 'is-hidden' : ''}"
                            th:attr="data-id=${p.productId}, data-visible=${p.isVisible}"
                            onclick="toggleProductVisibility(this)"
                            th:title="${p.isVisible ? 'ƒêang hi·ªán (B·∫•m ƒë·ªÉ ·∫©n)' : 'ƒêang ·∫©n (B·∫•m ƒë·ªÉ hi·ªán)'}">
                        <i th:class="${p.isVisible ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash'}"></i>
                    </button>

                    <button type="button" class="btn-action-icon btn-discount"
                            th:attr="data-id=${p.productId}, data-percent=${p.discountPercent}"
                            onclick="openDiscountModal(this)" title="Ch·ªânh m·ª©c gi·∫£m gi√° (Sale)">
                        <i class="fa-solid fa-tags"></i>
                    </button>
                </div>

                <div class="discount-ribbon" th:if="${p.discountPercent != null and p.discountPercent > 0}" th:text="'-' + ${p.discountPercent} + '%'"></div>

                <div class="card-img-wrapper">
                    <span class="status-badge bg-success">ƒêang b√°n</span>
                    <img th:if="${p.mainImage != null}" th:src="${p.mainImage.imageUrl}" class="card-img-top" alt="img">
                    <img th:unless="${p.mainImage != null}" src="https://via.placeholder.com/500?text=No+Image" class="card-img-top" alt="img">
                </div>

                <div class="card-body p-3 text-center">
                    <h6 class="fw-bold mb-1 text-truncate" th:text="${p.name}">T√™n B√°nh</h6>

                    <div class="stock-stats d-flex justify-content-between">
                        <span class="text-secondary">ƒê√£ l√†m: <b class="text-primary orig-init-text" th:text="${initialQty}">0</b></span>
                        <span class="text-secondary">C√≤n k·ªá: <b class="text-danger avail-qty-text" th:text="${availQty}">0</b></span>
                    </div>

                    <div class="stepper">
                        <button type="button" class="btn-step minus" onclick="updateCardQty(this, -1)"><i class="fa-solid fa-minus"></i></button>

                        <input type="number" class="stepper-input qty-input"
                               th:value="${initialQty}"
                               th:attr="data-orig-init=${initialQty}, data-orig-avail=${availQty}"
                               min="0" onchange="updateVisuals(this)">

                        <button type="button" class="btn-step plus" onclick="updateCardQty(this, 1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <small class="text-muted d-block mt-2" style="font-size: 0.7rem;">*(Nh·∫≠p t·ªïng b√°nh l√†m h√¥m nay)*</small>
                </div>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(products)}" class="col-12 text-center py-5">
            <i class="fa-solid fa-box-open fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong h·ªá th·ªëng!</h5>
            <a href="/admin/products" class="btn btn-primary mt-2">Qu·∫£n l√Ω S·∫£n Ph·∫©m</a>
        </div>

    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const serverDate = /*[[${selectedDate != null ? selectedDate.toString() : null}]]*/ null;
        const dateInput = document.getElementById('saleDate');

        // L·∫•y ng√†y h√¥m nay chu·∫©n ƒë·ªãnh d·∫°ng YYYY-MM-DD
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        if (serverDate && serverDate !== "null") {
            dateInput.value = serverDate;
        } else {
            dateInput.value = todayStr;
        }

        dateInput.addEventListener('change', function() {
            window.location.href = '/admin/daily-stock?date=' + this.value;
        });

        // Kh·ªüi t·∫°o tr·∫°ng th√°i m√†u s·∫Øc
        document.querySelectorAll('.qty-input').forEach(input => {
            updateVisuals(input);
        });

        // üî• LOGIC CH·∫∂N NG√ÄY QU√Å KH·ª® B·∫ÆT ƒê·∫¶U T·ª™ ƒê√ÇY
        if (dateInput.value < todayStr) {
            // 1. V√¥ hi·ªáu h√≥a t·∫•t c·∫£ √¥ input v√† ƒë·ªïi m√†u ch·ªØ
            document.querySelectorAll('.qty-input').forEach(input => {
                input.disabled = true;
                input.style.color = '#adb5bd'; // Ch·ªØ x√°m l·∫°i
            });

            // 2. ·∫®n t·∫•t c·∫£ n√∫t + / -
            document.querySelectorAll('.btn-step').forEach(btn => {
                btn.style.display = 'none';
            });

            // 3. Kh√≥a v√† l√†m m·ªù n√∫t L∆∞u ƒê·ªìng B·ªô
            const saveBtn = document.querySelector('button[onclick="saveAllStock()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.classList.replace('btn-info', 'btn-secondary');
                saveBtn.innerHTML = '<i class="fa-solid fa-lock me-2"></i>Ch·ªâ Xem';
            }

            // 4. B·∫≠t th√¥ng b√°o nh·∫π nh√†ng cho ng∆∞·ªùi d√πng bi·∫øt
            Swal.fire({
                toast: true, position: 'top-end', icon: 'info',
                title: 'ƒêang ·ªü ch·∫ø ƒë·ªô xem l·ªãch s·ª≠',
                text: 'Kh√¥ng th·ªÉ ch·ªânh s·ª≠a d·ªØ li·ªáu c·ªßa ng√†y qu√° kh·ª©',
                showConfirmButton: false, timer: 3000
            });
        }
    });

    // H√†m b·∫•m n√∫t + / -
    function updateCardQty(btnElement, change) {
        let inputEl = btnElement.parentElement.querySelector('.qty-input');
        let currentVal = parseInt(inputEl.value) || 0;
        inputEl.value = currentVal + change;
        updateVisuals(inputEl);
    }

    // H√†m T√≠nh to√°n T·ªìn Kho Real-time v√† ƒë·ªïi m√†u th·∫ª
    function updateVisuals(inputEl) {
        let newVal = parseInt(inputEl.value) || 0;

        // L·∫•y s·ªë li·ªáu g·ªëc l√∫c load trang
        let origInit = parseInt(inputEl.getAttribute('data-orig-init')) || 0;
        let origAvail = parseInt(inputEl.getAttribute('data-orig-avail')) || 0;

        // T√≠nh s·ªë b√°nh ƒë√£ b√°n: (S·ªë nh·∫≠p ban ƒë·∫ßu - S·ªë tr√™n k·ªá l√∫c ƒë·∫ßu)
        let soldQty = origInit - origAvail;

        // B·∫¢O V·ªÜ D·ªÆ LI·ªÜU: Kh√¥ng cho ph√©p nh·∫≠p T·ªïng l√†m < S·ªë b√°nh ƒë√£ b√°n
        if (newVal < soldQty) {
            Swal.fire({
                toast: true, position: 'top-end', icon: 'error',
                title: `ƒê√£ b√°n ${soldQty} c√°i! Kh√¥ng th·ªÉ s·ª≠a t·ªïng nh·ªè h∆°n ${soldQty}.`,
                showConfirmButton: false, timer: 3000
            });
            newVal = soldQty;
            inputEl.value = newVal;
        }

        // T√≠nh t·ªìn kho tr√™n k·ªá hi·ªán t·∫°i
        let newAvail = newVal - soldQty;

        // C·∫≠p nh·∫≠t UI
        let card = inputEl.closest('.product-card');
        let availTextEl = card.querySelector('.avail-qty-text');
        let badge = card.querySelector('.status-badge');

        availTextEl.innerText = newAvail;

        // ƒê·ªïi m√†u Badge d·ª±a tr√™n S·ªë C√≤n K·ªá (newAvail)
        if (newAvail <= 0) {
            card.classList.add('out-of-stock');
            badge.className = 'status-badge bg-danger';
            badge.innerText = 'H·∫øt h√†ng';
        } else if (newAvail <= 5) {
            card.classList.remove('out-of-stock');
            badge.className = 'status-badge bg-warning text-dark';
            badge.innerText = 'S·∫Øp h·∫øt';
        } else {
            card.classList.remove('out-of-stock');
            badge.className = 'status-badge bg-success';
            badge.innerText = 'ƒêang b√°n';
        }
    }

    function saveAllStock() {
        let date = document.getElementById('saleDate').value;
        let dataToSave = [];

        document.querySelectorAll('.filter-item').forEach(card => {
            let productId = card.getAttribute('data-product-id');
            let inputEl = card.querySelector('.qty-input');

            // B·∫¢O V·ªÜ FRONTEND: L·∫•y gi√° tr·ªã, n·∫øu r·ªóng ho·∫∑c l·ªói th√¨ g√°n lu√¥n b·∫±ng 0
            let qty = parseInt(inputEl.value);
            if (isNaN(qty)) {
                qty = 0;
            }

            dataToSave.push({ productId: productId, quantity: qty });
        });

        let payload = {
            date: date,
            items: dataToSave
        };

        Swal.fire({
            title: 'ƒêang l∆∞u d·ªØ li·ªáu...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        fetch('/admin/daily-stock/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'ƒê√£ l∆∞u ƒë·ªìng b·ªô!',
                    text: `D·ªØ li·ªáu ng√†y ${date} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.`,
                    confirmButtonColor: '#198754'
                }).then(() => {
                    location.reload(); // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë g·ªëc m·ªõi
                });
            } else {
                Swal.fire('L·ªói!', data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        })
        .catch(error => {
            console.error('L·ªói:', error);
            Swal.fire('L·ªói k·∫øt n·ªëi!', 'Kh√¥ng th·ªÉ li√™n l·∫°c v·ªõi m√°y ch·ªß', 'error');
        });
    }
    function toggleProductVisibility(btn) {
        let productId = btn.getAttribute('data-id');
        let isVisible = btn.getAttribute('data-visible') === 'true';
        let actionText = isVisible ? "·∫®n kh·ªèi c·ª≠a h√†ng" : "Hi·ªán l·∫°i tr√™n c·ª≠a h√†ng";

        Swal.fire({
            title: actionText + '?',
            text: isVisible ? "Kh√°ch h√†ng s·∫Ω kh√¥ng nh√¨n th·∫•y b√°nh n√†y tr√™n Web n·ªØa." : "B√°nh s·∫Ω ƒë∆∞·ª£c b√°n b√¨nh th∆∞·ªùng tr√™n Web.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: isVisible ? '#dc3545' : '#198754',
            confirmButtonText: 'ƒê·ªìng √Ω',
            cancelButtonText: 'H·ªßy'
        }).then((result) => {
            if (result.isConfirmed) {
                // G·ªçi API
                fetch(`/admin/products/toggle-visibility/${productId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        Swal.fire({toast: true, position: 'top-end', icon: 'success', title: data.message, showConfirmButton: false, timer: 2000});
                        setTimeout(() => location.reload(), 1000); // T·∫£i l·∫°i trang ƒë·ªÉ update UI
                    } else {
                        Swal.fire('L·ªói!', data.message, 'error');
                    }
                });
            }
        });
    }

    // H√ÄM 2: X·ª≠ l√Ω n√∫t Gi·∫£m gi√° (Nh·∫≠p s·ªë tr·ª±c ti·∫øp)
    function openDiscountModal(btn) {
        let productId = btn.getAttribute('data-id');
        let currentPercent = btn.getAttribute('data-percent') || 0;

        Swal.fire({
            title: 'C√†i ƒë·∫∑t gi·∫£m gi√° (%)',
            input: 'number',
            inputLabel: 'Nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 100 (Nh·∫≠p 0 ƒë·ªÉ t·∫Øt gi·∫£m gi√°)',
            inputValue: currentPercent,
            inputAttributes: { min: 0, max: 100, step: 1 },
            showCancelButton: true,
            confirmButtonText: 'L∆∞u M·ª©c Sale',
            confirmButtonColor: '#fd7e14',
            preConfirm: (value) => {
                if (!value || value < 0 || value > 100) {
                    Swal.showValidationMessage('Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá t·ª´ 0 ƒë·∫øn 100');
                }
                return value;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                let percent = result.value;
                // G·ªçi API truy·ªÅn percent
                fetch(`/admin/products/update-discount/${productId}?percent=${percent}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        Swal.fire({toast: true, position: 'top-end', icon: 'success', title: data.message, showConfirmButton: false, timer: 2000});
                        setTimeout(() => location.reload(), 1000); // T·∫£i l·∫°i trang ƒë·ªÉ hi·ªán d·∫£i bƒÉng Sale
                    } else {
                        Swal.fire('L·ªói!', data.message, 'error');
                    }
                });
            }
        });
    }
</script>
</body>
</html>