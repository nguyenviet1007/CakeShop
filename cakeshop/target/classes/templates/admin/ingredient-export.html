<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xuất Kho Thủ Công - Bakery Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .card-box { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: white; }
        .stock-badge {
            font-size: 0.9rem; padding: 8px 10px; border-radius: 6px;
            background: #e9ecef; color: #495057; display: block; width: 100%; text-align: center;
        }
        /* Highlight khi tồn kho thấp */
        .stock-low { background: #ffcccc; color: #cc0000; font-weight: bold; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 fw-bold text-warning"><i class="fa-solid fa-hand-holding-hand me-2"></i>Xuất Kho Thủ Công</h2>
            <p class="text-muted mb-0">Dành cho: Hủy hàng, làm mẫu thử, hoặc điều chỉnh kho.</p>
        </div>
        <a th:href="@{/admin/ingredients}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i>Quay lại
        </a>
    </div>

    <div class="card-box p-4">
        <form id="exportForm">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 5%" class="text-center">STT</th>
                        <th style="width: 30%">Nguyên Liệu</th>
                        <th style="width: 20%" class="text-center">Tồn kho hiện tại</th>
                        <th style="width: 20%">Số lượng lấy ra</th>
                        <th style="width: 20%">Lý do xuất</th>
                        <th style="width: 5%"></th>
                    </tr>
                    </thead>
                    <tbody id="manualTable">
                    <tr class="export-row">
                        <td class="text-center text-muted index">1</td>
                        <td>
                            <select class="form-select fw-bold ingredient-select" onchange="updateInfo(this)" required>
                                <option value="" selected disabled>-- Chọn nguyên liệu --</option>
                                <th:block th:each="item : ${ingredients}">
                                    <option th:value="${item.ingredientId}"
                                            th:text="${item.name}"
                                            th:data-unit="${item.unit}"
                                            th:data-stock="${item.stock != null ? item.stock.quantity : 0}">
                                    </option>
                                </th:block>
                            </select>
                        </td>
                        <td>
                            <span class="stock-badge">---</span>
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="number" class="form-control text-center text-warning fw-bold border-warning qty-input"
                                       min="0.01" step="0.01" required placeholder="0">
                                <span class="input-group-text unit-label">Đv</span>
                            </div>
                        </td>
                        <td>
                            <input type="text" class="form-control note-input" placeholder="Ví dụ: Hư hỏng...">
                        </td>
                        <td class="text-center">
                            <i class="fa-solid fa-trash text-danger cursor-pointer" onclick="removeRow(this)"></i>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                <button type="button" class="btn btn-outline-dark border-dashed" onclick="addRow()">
                    <i class="fa-solid fa-plus me-1"></i> Thêm dòng
                </button>
                <button type="button" onclick="submitExport()" class="btn btn-warning px-5 fw-bold shadow-sm">
                    <i class="fa-solid fa-dolly me-2"></i>XÁC NHẬN XUẤT
                </button>
            </div>
        </form>
    </div>
</div>

<div id="ingredientOptions" style="display:none;">
    <option value="" selected disabled>-- Chọn nguyên liệu --</option>
    <th:block th:each="item : ${ingredients}">
        <option th:value="${item.ingredientId}"
                th:text="${item.name}"
                th:data-unit="${item.unit}"
                th:data-stock="${item.stock != null ? item.stock.quantity : 0}">
        </option>
    </th:block>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // 1. Cập nhật thông tin khi chọn nguyên liệu (Tồn kho & Đơn vị)
    function updateInfo(selectElement) {
        const option = selectElement.options[selectElement.selectedIndex];
        const row = selectElement.closest('tr');

        const stock = parseFloat(option.getAttribute('data-stock') || 0);
        const unit = option.getAttribute('data-unit') || 'Đv';

        // Update Unit Label
        row.querySelector('.unit-label').innerText = unit;

        // Update Stock Badge
        const badge = row.querySelector('.stock-badge');
        badge.innerHTML = `Còn: <b>${stock}</b> ${unit}`;

        // Cảnh báo nếu tồn = 0
        if (stock <= 0) {
            badge.classList.add('stock-low');
            badge.innerHTML = `<i class="fa-solid fa-triangle-exclamation me-1"></i>Hết hàng`;
        } else {
            badge.classList.remove('stock-low');
        }
    }

    // 2. Thêm dòng
    function addRow() {
        const table = document.getElementById('manualTable');
        const newRow = table.insertRow();
        newRow.className = "export-row";
        const optionsHtml = document.getElementById('ingredientOptions').innerHTML;

        newRow.innerHTML = `
            <td class="text-center text-muted index"></td>
            <td>
                <select class="form-select fw-bold ingredient-select" onchange="updateInfo(this)" required>
                    ${optionsHtml}
                </select>
            </td>
            <td><span class="stock-badge">---</span></td>
            <td>
                <div class="input-group">
                    <input type="number" class="form-control text-center text-warning fw-bold border-warning qty-input"
                           min="0.01" step="0.01" required placeholder="0">
                    <span class="input-group-text unit-label">Đv</span>
                </div>
            </td>
            <td><input type="text" class="form-control note-input" placeholder="Lý do..."></td>
            <td class="text-center">
                <i class="fa-solid fa-trash text-danger cursor-pointer" onclick="removeRow(this)"></i>
            </td>
        `;
        updateCount();
    }

    // 3. Xóa dòng
    function removeRow(element) {
        const tbody = document.getElementById('manualTable');
        if (tbody.rows.length > 1) {
            element.closest('tr').remove();
            updateCount();
        } else {
            Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'Cần ít nhất 1 dòng', showConfirmButton: false, timer: 3000 });
        }
    }

    function updateCount() {
        document.querySelectorAll('#manualTable tr').forEach((row, i) => {
            row.querySelector('.index').innerText = i + 1;
        });
    }

    // 4. Submit Form
    function submitExport() {
        const rows = document.querySelectorAll('.export-row');
        let data = [];
        let isValid = true;
        let errorMessage = "";

        rows.forEach(row => {
            const id = row.querySelector('.ingredient-select').value;
            const qty = parseFloat(row.querySelector('.qty-input').value);
            const note = row.querySelector('.note-input').value;

            // Lấy tồn kho hiện tại từ data attribute để check sơ bộ phía client
            const selectedOption = row.querySelector('.ingredient-select option:checked');
            const currentStock = parseFloat(selectedOption.getAttribute('data-stock') || 0);

            if (!id) {
                isValid = false; errorMessage = "Vui lòng chọn nguyên liệu"; return;
            }
            if (!qty || qty <= 0) {
                isValid = false; errorMessage = "Số lượng phải > 0"; return;
            }
            if (qty > currentStock) {
                isValid = false;
                errorMessage = `Nguyên liệu ${selectedOption.text} không đủ tồn kho (Còn: ${currentStock})`;
                return;
            }

            data.push({
                ingredientId: parseInt(id),
                quantity: qty,
                note: note // Gửi kèm lý do
            });
        });

        if (!isValid) {
            Swal.fire('Lỗi', errorMessage, 'error');
            return;
        }

        // Gửi AJAX
        fetch('/admin/ingredients/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            if (result.status === 'success') {
                Swal.fire({
                    title: 'Đã xuất kho!',
                    text: 'Kho đã được cập nhật.',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => window.location.href = '/admin/ingredients');
            } else {
                Swal.fire('Lỗi Server', result.message, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Lỗi', 'Không thể kết nối đến server', 'error');
        });
    }
</script>
</body>
</html>