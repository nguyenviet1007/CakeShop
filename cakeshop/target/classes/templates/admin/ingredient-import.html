<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nhập Kho - Bakery Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .card-box { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: none; }

        /* Input số lượng nổi bật */
        .qty-input {
            font-weight: bold;
            color: #198754;
            text-align: center;
            border: 2px solid #ced4da;
        }
        .qty-input:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
        /* Style cho nút xóa */
        .btn-remove { color: #dc3545; transition: 0.2s; }
        .btn-remove:hover { color: #bb2d3b; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 fw-bold text-success"><i class="fa-solid fa-boxes-packing me-2"></i>Nhập Hàng Vào Kho</h2>
            <p class="text-muted mb-0">Chọn nguyên liệu và nhập số lượng thực tế.</p>
        </div>
        <a th:href="@{/admin/ingredients}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i>Quay lại danh sách
        </a>
    </div>

    <div class="card-box p-4">
        <form id="importForm">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 5%" class="text-center">STT</th>
                        <th style="width: 50%">Tên Nguyên Liệu</th>
                        <th style="width: 15%" class="text-center">Đơn vị</th>
                        <th style="width: 25%">Số lượng nhập thêm</th>
                        <th style="width: 5%"></th>
                    </tr>
                    </thead>
                    <tbody id="inputTable">
                    <tr class="import-row">
                        <td class="text-center text-muted index">1</td>
                        <td>
                            <select class="form-select ingredient-select" onchange="updateUnit(this)" required>
                                <option value="" selected disabled>-- Chọn nguyên liệu --</option>
                                <th:block th:each="item : ${ingredients}">
                                    <option th:value="${item.ingredientId}"
                                            th:text="${item.name}"
                                            th:data-unit="${item.unit}"></option>
                                </th:block>
                            </select>
                        </td>
                        <td><input type="text" class="form-control bg-light text-center unit-display border-0" readonly></td>

                        <td>
                            <input type="number" class="form-control qty-input" min="0.01" step="0.01" placeholder="0" required>
                        </td>

                        <td class="text-center">
                            <i class="fa-solid fa-trash-can fs-5 btn-remove cursor-pointer" onclick="removeRow(this)" style="cursor: pointer;"></i>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <button type="button" class="btn btn-outline-primary border-dashed" onclick="addRow()">
                    <i class="fa-solid fa-plus me-1"></i> Thêm dòng
                </button>

                <button type="button" onclick="submitImport()" class="btn btn-success btn-lg px-5 fw-bold shadow">
                    <i class="fa-solid fa-check me-2"></i> LƯU KHO
                </button>
            </div>
        </form>
    </div>
</div>

<div id="ingredientOptions" style="display:none;">
    <option value="" selected disabled>-- Chọn nguyên liệu --</option>
    <th:block th:each="item : ${ingredients}">
        <option th:value="${item.ingredientId}" th:text="${item.name}" th:data-unit="${item.unit}"></option>
    </th:block>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script>
    // 1. Tự động điền đơn vị khi chọn nguyên liệu
    function updateUnit(selectElement) {
        // Lấy option đang được chọn
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        // Lấy data-unit
        const unit = selectedOption.getAttribute('data-unit');
        // Tìm ô input unit trong cùng dòng
        const row = selectElement.closest('tr');
        row.querySelector('.unit-display').value = unit || '';
    }

    // 2. Xóa dòng
    function removeRow(element) {
        const tableBody = document.getElementById('inputTable');
        if (tableBody.rows.length > 1) {
            element.closest('tr').remove();
            updateCount(); // Cập nhật lại số thứ tự
        } else {
            // Dùng Toast nhỏ của SweetAlert
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
            });
            Toast.fire({ icon: 'warning', title: 'Phải có ít nhất 1 dòng nhập liệu' });
        }
    }

    // 3. Thêm dòng mới
    function addRow() {
        const table = document.getElementById('inputTable');
        const newRow = table.insertRow();
        newRow.className = "import-row";

        // Lấy HTML options từ template ẩn
        const optionsHtml = document.getElementById('ingredientOptions').innerHTML;

        newRow.innerHTML = `
            <td class="text-center text-muted index"></td>
            <td>
                <select class="form-select ingredient-select" onchange="updateUnit(this)" required>
                    ${optionsHtml}
                </select>
            </td>
            <td><input type="text" class="form-control bg-light text-center unit-display border-0" readonly></td>
            <td>
                <input type="number" class="form-control qty-input" min="0.01" step="0.01" placeholder="0" required>
            </td>
            <td class="text-center">
                <i class="fa-solid fa-trash-can fs-5 btn-remove cursor-pointer" onclick="removeRow(this)" style="cursor: pointer;"></i>
            </td>
        `;
        updateCount();
    }

    // 4. Cập nhật STT (1, 2, 3...)
    function updateCount() {
        const rows = document.querySelectorAll('#inputTable tr');
        rows.forEach((row, index) => {
            row.querySelector('.index').innerText = index + 1;
        });
    }

    // 5. GỬI DỮ LIỆU (QUAN TRỌNG)
    function submitImport() {
        const rows = document.querySelectorAll('.import-row');
        let data = [];
        let hasError = false;

        rows.forEach(row => {
            const ingId = row.querySelector('.ingredient-select').value;
            const qty = row.querySelector('.qty-input').value;

            // Validate đơn giản
            if (!ingId || !qty || parseFloat(qty) <= 0) {
                hasError = true;
                return;
            }

            // Đóng gói thành object khớp với IngredientDTO
            data.push({
                ingredientId: parseInt(ingId),
                quantity: parseFloat(qty),
                // Các trường name, unit, minQuantity ko cần gửi lên vì Backend tự tra cứu theo ID
            });
        });

        if (hasError || data.length === 0) {
            Swal.fire('Cảnh báo', 'Vui lòng chọn nguyên liệu và nhập số lượng hợp lệ (>0)!', 'warning');
            return;
        }

        // Gọi AJAX
        fetch('/admin/ingredients/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Đã nhập kho xong!',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = '/admin/ingredients'; // Quay về trang danh sách
                });
            } else {
                Swal.fire('Lỗi', result.message, 'error');
            }
        })
        .catch(error => {
            console.error(error);
            Swal.fire('Lỗi Server', 'Không thể kết nối!', 'error');
        });
    }
</script>

</body>
</html>